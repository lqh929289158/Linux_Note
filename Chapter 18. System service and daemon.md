# Chapter 18. System service and daemon

# 1. What is `daemon` and service
## 1.1 `daemon` types

### stand_alone: start a service by itself

Daemon can start a service without other mechanism. The loaded daemon will stay in the memory all the time but the response is **fast** too.

### super_daemon: one daemon manages all services

When there is no request, `xinetd`(super_daemon) will deallocate all resources. It will call service when requests come from clients. `xinetd` has **security** mechanism. No busy system resources. But it will be **slower** to respond request!

### signal-control and interval-control

## 1.2 Service and Port

The mapping from port to service is stored in `/etc/services`.

```
[root@www ~]# cat /etc/services
....(前面省略)....
ftp             21/tcp
ftp             21/udp          fsp fspd
ssh             22/tcp                          # SSH Remote Login Protocol
ssh             22/udp                          # SSH Remote Login Protocol
....(中间省略)....
http            80/tcp          www www-http    # WorldWideWeb HTTP
http            80/udp          www www-http    # HyperText Transfer Protocol
....(底下省略)....
# 这个文件的内容是以底下的方式来编排的：
# <daemon name>   <port/封包协议>   <该服务的说明>
```

## 1.3 Daemon start script

The PID of the programs that daemons started will be logged at `/var/run`

To start a daemon, you have to consider files to use, configuration files, running environment and so on. So it will be safer and easier to start a daemon with a script.

- `/etc/init.d/*`: Start script.(**IMPORTANT**)
- `/etc/sysconfig/*`: Configuration files.(IMPORTANT)
- `/etc/xinetd.conf`, `/etc/xinetd.d/*`: Configuration files of super daemon.
- `/etc/*`: Configuration files of each service
- `/var/lib/*`: The libraries generated by each service.
- `/var/run/*`: The PID of each service.

### Stand alone `/etc/init.d/*`

```
[root@www ~]# /etc/init.d/syslog
用法: /etc/init.d/syslog {start|stop|status|restart|condrestart}
# 什么参数都不加的时候，系统会告诉你可以用的参数有哪些，如上所示。

范例一：观察 syslog 这个 daemon 目前的状态
[root@www ~]# /etc/init.d/syslog status
syslogd (pid 4264) 正在运行...
klogd (pid 4267) 正在运行...
# 代表 syslog 管理两个 daemon ，这两个 daemon 正在运行中啦！

范例二：重新让 syslog 读取一次配置文件
[root@www ~]# /etc/init.d/syslog restart
正在关闭核心记录器:          [  确定  ]
正在关闭系统记录器:          [  确定  ]
正在启动系统记录器:          [  确定  ]
正在启动核心记录器:          [  确定  ]
[root@www ~]# /etc/init.d/syslog status
syslogd (pid 4793) 正在运行...
klogd (pid 4796) 正在运行...
# 因为重新启动过，所以 PID 与第一次观察的值就不一样了！这样了解乎？
```

Use `service` command to control all services.

```
[root@www ~]# service [service name] (start|stop|restart|...)
[root@www ~]# service --status-all
选项与参数：
service name：亦即是需要启动的服务名称，需与 /etc/init.d/ 对应；
start|...   ：亦即是该服务要进行的工作。
--status-all：将系统所有的 stand alone 的服务状态通通列出来

范例三：重新启动 crond 这支 daemon ：
[root@www ~]# service crond restart
[root@www ~]# /etc/init.d/crond restart
# 这两种方法随便你用哪一种来处理都可以！不过鸟哥比较喜欢使用 /etc/init.d/*

范例四：显示出目前系统上面所有服务的运行状态
[root@www ~]# service --status-all
acpid (pid 4536) 正在运行...
anacron 已停止
atd (pid 4694) 正在运行...
....(底下省略)....
```

### Super daemon

```
[root@www ~]# grep -i 'disable' /etc/xinetd.d/*
....(前面省略)....
/etc/xinetd.d/rsync:          disable = yes
/etc/xinetd.d/tcpmux-server:  disable = yes
/etc/xinetd.d/time-dgram:     disable = yes
/etc/xinetd.d/time-stream:    disable = yes
```

```
# 1. 先修改配置文件成为启动的模样：
[root@www ~]# vim /etc/xinetd.d/rsync
# 请将 disable 那一行改成如下的模样 (原本是 yes 改成 no 就对了)
service rsync
{
        disable = no
....(后面省略)....

# 2. 重新启动 xinetd 这个服务
[root@www ~]# /etc/init.d/xinetd restart
正在停止 xinetd:             [  确定  ]
正在激活 xinetd:             [  确定  ]

# 3. 观察启动的端口
[root@www ~]# grep 'rsync' /etc/services  <==先看看端口是哪一号
rsync           873/tcp               # rsync
rsync           873/udp               # rsync
[root@www ~]# netstat -tnlp | grep 873
tcp    0 0 0.0.0.0:873      0.0.0.0:*     LISTEN      4925/xinetd
# 注意看！启动的服务并非 rsync 喔！而是 xinetd ，因为他要控管 rsync 嘛！
# 若有疑问，一定要去看看图 1.1.1 才行！
```

You have to modify the configuration file in `/etc/xinetd.d/` and then restart **xinetd**(a stand alone daemon).

# 2. Analyze configuration of **super daemon**

## 2.1 Default configuration file `xinetd.conf`

```
[root@www ~]# vim /etc/xinetd.conf
defaults
{
# 服务启动成功或失败，以及相关登陆行为的记录文件
        log_type        = SYSLOG daemon info  <==登录文件的记录服务类型
        log_on_failure  = HOST   <==发生错误时需要记录的信息为主机 (HOST)
        log_on_success  = PID HOST DURATION EXIT <==成功启动或登陆时的记录信息
# 允许或限制联机的默认值
        cps         = 50 10 <==同一秒内的最大联机数为 50 个，若超过则暂停 10 秒
        instances   = 50    <==同一服务的最大同时联机数
        per_source  = 10    <==同一来源的客户端的最大联机数
# 网络 (network) 相关的默认值
        v6only          = no <==是否仅允许 IPv6 ？可以先暂时不启动 IPv6 支持！
# 环境参数的配置
        groups          = yes
        umask           = 002
}

includedir /etc/xinetd.d <==更多的配置值在 /etc/xinetd.d 那个目录内
```

The format of `/etc/xinetd.d/xxx.conf`
```
service  <service_name>
{
       <attribute>   <assign_op>   <value>   <value> ...
       .............
}
```

- `service`:keyword
- `<service_name>`: the same service name in `/etc/services`
- `<assign_op>`: 
  - **=**: assign parameters as follows
  - **+=**: add parameters as follows
  - **-=**: remove parameters as follows

| attribute | value | meaning |
| --------- | ----- | ------- |
| disable | yes or no | disable |
| id | numeber | the identifier for different services(even for same services with different configurations) |
| server | the absolute path of the program | the path of the start program of the service |
| server_args | `--daemon` etc. | parameters for server attributes |
| user | UID of the service program | start the service by which user's ID |
| group | GID of the service program | start the service by which group's ID |


# 3. Firewall of service `xinetd`, `TCP Wrappers`

# 4. Services started by system
